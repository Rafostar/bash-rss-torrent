#!/bin/sh

echo "
------------------------
 SHELL RSS TORRENT v1.8
   Script by Rafostar
------------------------
"

INDENT1="  "
INDENT2="     "
UPPER="ABCDEFGHIJKLMNOPQRSTUVWXYZ/ĄĆĘŁŃÓŚŹŻ"
LOWER="abcdefghijklmnopqrstuvwxyz/ąćęłńóśźż"
UA="Mozilla/5.0 (Windows NT 6.1; WOW64; rv:54.0) Gecko/20100101 Firefox/72.0"

parse_config() {
    WatchDir=$(xmllint --xpath "string(//config/watchdir[1]/text())" "$ConfigPath" 2> /dev/null)
    if [ "$?" -ne 0 ]
    then
        echo "Error: invalid config file"
    elif [ -z "$WatchDir" ]
    then
        echo "Error: no <watchdir> in config file"
    else
        echo "Torrents will be downloaded to: $WatchDir"

        HistoryPath=$(xmllint_from_config "string(//config/history[1]/text())")
        if [ ! -z "$HistoryPath" ]
        then
            echo "Using download history file: $HistoryPath"

            if [ -f "$HistoryPath" ]
            then
                HistoryData=$(cat "$HistoryPath")
            fi
        fi

        FeedsCount=$(xmllint_from_config "count(//config/feed)")
        echo "Total feeds in config: $FeedsCount"
        echo ""

        feed=1
        while [ $feed -le $FeedsCount ]
        do
            FeedUrl=$(xmllint_from_config "string(//config/feed[$feed]/url[1]/text())")

            if [ -z "$FeedUrl" ]
            then
                echo "Error: feed $feed has no URL"
            else
                FeedData=$(wget -U "$UA" -O - "$FeedUrl" 2> /dev/null)

                if [ -z "$FeedData" ]
                then
                    FeedData=$(wget -O - "$FeedUrl" 2> /dev/null)
                fi

                if [ -z "$FeedData" ]
                then
                    echo "Error: feed $feed has no data"
                else
                    echo "feed $feed: $FeedUrl"

                    for QueryFn in "contains" "starts-with"
                    do
                        find_in_feed $feed
                    done

                    find_in_feed_multi $feed
                fi
            fi

            feed=$(( feed + 1 ))
        done
    fi
}

find_in_feed() {
    QueryPath="//config/feed[$1]/$QueryFn"
    QueryCount=$(xmllint_from_config "count($QueryPath)")

    if [ "$QueryCount" -ge 1 ]
    then
        query=1
        while [ $query -le $QueryCount ]
        do
            find_attributes_matches $query
            TorrentCount=$(xmllint_from_feed "count($Matches/link)")
            echo "$INDENT1 $QueryFn $query: $QueryText, found: $TorrentCount"

            if [ "$TorrentCount" -ge 1 ]
            then
                get_torrents
            fi

            query=$(( query + 1 ))
        done
    fi
}

find_in_feed_multi() {
    MultiPath="//config/feed[$1]/multi"
    MultiCount=$(xmllint_from_config "count($MultiPath)")

    if [ "$MultiCount" -ge 1 ]
    then
        multi=1
        while [ $multi -le $MultiCount ]
        do
            QueryFn="starts-with"
            QueryPath="$MultiPath[$multi]/$QueryFn"
            QueryCount=$(xmllint_from_config "count($QueryPath)")
            CustomFeed="$FeedData"
            MultiText=""

            if [ "$QueryCount" -ge 1 ]
            then
                find_attributes_matches "1"
                CustomFeed=$(xmllint_from_feed "$Matches")

                if [ ! -z "$CustomFeed" ]
                then
                    CustomFeed="<rss>$CustomFeed</rss>"
                    MultiText="$QueryText"
                else
                    CustomFeed=""
                    echo "$INDENT1 multi $multi: $QueryText, found: 0"
                    return
                fi
            fi

            QueryFn="contains"
            QueryPath="$MultiPath[$multi]/$QueryFn"
            QueryCount=$(xmllint_from_config "count($QueryPath)")

            if [ "$QueryCount" -ge 1 ]
            then
                query=1
                while [ $query -le $QueryCount ]
                do
                    find_attributes_matches "$query"
                    CustomFeed=$(xmllint_from_feed "$Matches")

                    if [ ! -z "$CustomFeed" ]
                    then
                        CustomFeed="<rss>$CustomFeed</rss>"

                        if [ ! -z "$MultiText" ]
                        then
                            MultiText="$MultiText | $QueryText"
                        else
                            MultiText="$QueryText"
                        fi
                    else
                        CustomFeed=""
                        echo "$INDENT1 multi $multi: $QueryText, found: 0"
                        return
                    fi

                    query=$(( query + 1 ))
                done
                get_torrents_multi $multi
            else
                get_torrents_multi $multi
            fi

            multi=$(( multi + 1 ))
        done

        CustomFeed=""
    fi
}

find_attributes_matches() {
    QueryText=$(xmllint_from_config "string($QueryPath[$1]/text())")
    IgnoreCase=$(xmllint_from_config "count($QueryPath[$1][@ignore-case='1'])")

    if [ "$IgnoreCase" -eq 1 ]
    then
        ParsedQuery=$(xmllint_from_config "translate($QueryPath[$query]/text(), '$UPPER', '$LOWER')")
        Matches="//item[title[$QueryFn(translate(., '$UPPER', '$LOWER'), '$ParsedQuery')]]"
    else
        Matches="//item[title[$QueryFn(., '$QueryText')]]"
    fi
}

find_torrent_attr() {
    ATTR=$(xmllint_from_feed "count($Matches[$torrent]/$1)")
    if [ "$ATTR" -eq 1 ]
    then
        ATTR_TORRENT=$(xmllint_from_feed "count($Matches[$torrent]/$1[@type='application/x-bittorrent'])")
        if [ "$ATTR_TORRENT" -eq 1 ]
        then
            ATTR_URL=$(xmllint_from_feed "string($Matches[$torrent]/$1/@url)")
            if [ ! -z "$ATTR_URL" ]
            then
                echo "$ATTR_URL"
            fi
        fi
    fi
}

get_torrents() {
    torrent=1
    while [ $torrent -le $TorrentCount ]
    do
        TorrentLink=$(find_torrent_attr "enclosure")

        if [ -z "$TorrentLink" ]
        then
            TorrentLink=$(xmllint_from_feed "string($Matches[$torrent]/link/text())")
        fi

        if [ ! -z "$TorrentLink" ]
        then
            if [ ! -z "$HistoryData" ]
            then
                case "$HistoryData" in
                    *"$TorrentLink"*) echo "$INDENT2 torrent $torrent in download history" ;;
                    *) download_torrent "$TorrentLink" ;;
                esac
            else
                download_torrent "$TorrentLink"
            fi
        else
            echo "$INDENT2 torrent $torrent without a link"
        fi

        torrent=$(( torrent + 1 ))
    done
}

get_torrents_multi() {
    TorrentCount=$(xmllint_from_feed "count($Matches/link)")
    echo "$INDENT1 multi $1: $MultiText, found: $TorrentCount"

    if [ "$TorrentCount" -ge 1 ]
    then
        get_torrents
    fi
}

xmllint_from_config() {
    RESULT=$(xmllint --xpath "$1" "$ConfigPath" 2> /dev/null)
    echo "$RESULT"
}

xmllint_from_feed() {
    if [ ! -z "$CustomFeed" ]
    then
        XmlData="$CustomFeed"
    else
        XmlData="$FeedData"
    fi

    RESULT=$(echo "$XmlData" | xmllint --format --xpath "$1" - 2> /dev/null)
    echo "$RESULT"
}

write_to_history() {
    if [ ! -z "$HistoryPath" ]
    then
        echo "$1" >> "$HistoryPath"
    fi

    HistoryData=$(echo -e "$HistoryData\n$1")
}

download_torrent() {
    echo "$INDENT2 torrent $torrent: $1"

    wget -q --content-disposition -U "$UA" -P "$WatchDir" "$1" 2> /dev/null
    if [ $? -ne 0 ]
    then
        wget -P "$WatchDir" "$1" > /dev/null 2> /dev/null
        if [ $? -eq 0 ]
        then
            write_to_history "$1"
        fi
    else
        write_to_history "$1"
    fi
}

ConfigPath=$1
if [ -z "$ConfigPath" ]
then
    ME=$(basename "$0")
    echo "Usage: $ME <config_path>"
else
    if [ -f "$ConfigPath" ]
    then
        XmlInstalled=$(xmllint --version > /dev/null 2> /dev/null)
        if [ $? -eq 0 ]
        then
            parse_config
        else
            echo "Error: xmllint is not installed"
        fi
    else
        echo "Error: file $ConfigPath does not exist"
    fi
fi
